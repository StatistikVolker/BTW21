---
title: "Bundestagswahl 2021"
author: Volker Holzendorf, Stadtverwaltung Jena, FD Controlling und Statistik
output: 
  flexdashboard::flex_dashboard:
    
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
source("R-Codes/010_load packages.r")

# Icons:
# https://fontawesome.com/v5.15/icons?d=gallery
# https://fontawesome.com/v5.15/icons?d=gallery&p=2&m=free
# Link to use Icons in R:
# https://www.displayr.com/adding-icons-to-dashboards-using-font-awesome/


source("R-Codes/mkr_btw21karten.r")

load("Daten/BTW21Jena.RData")
#source("R-Codes/mkr_C19JFWplot_ia.r")

```


#BTW21
=======================================================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

### Gebietswahl für Kartendatstellung


```{r}
# Gebietswahl Auswahl
gebiet <- c( "Deutschland","Neue Länder (+Berlin)","Leipzig", "Jena")
gebietwk <- c("Wahlkreis","Wahlkreis","Ortsteil","Wahlbezirk")
selectInput("selectGebiet",
            "Wähle ein Gebiet zur Darstellung der Karten aus",
            gebiet,
            selected = "Jena",
            multiple = FALSE)


# Darstellungsart
darstellung <- c( "Parteihochburg","Wahlkreisgewinner")
selectInput("selectDarstellung", 
            "Was soll dargestellt werden?",
            darstellung,
            selected = "Wahlkreisgewinner",
            multiple = FALSE)

# Erst- oder ZWeit Stimme?
stimme <-c( "Erststimme","Zweitstimme")
selectInput("selectStimme", 
            "Welche Stimme der Wahl soll betrachtet werden?",
            stimme,
            selected = "Zweitstimme",
            multiple = FALSE)


#observe(selectedDarstellung(),{
#  if (selectedDarstellung() == "Parteihochburg"){
    party <-c( "SPD", "CDU/CSU","GRÜNE","FDP","AfD","DIE LINKE")
    partycols <- c("red","black","forestgreen","yellow","darkblue","purple")
    selectInput("selectPartei", 
                "falls Parteihochburg: Welche Partei soll betrachtet werden?",
                party,
                selected = "",
                multiple = FALSE)
    
#  }
#})
```

Row
-----------------------------------------------------------------------

### Gebiet {.value-box}



```{r}

# 


# Angabe des Gebietes, das Dargestellt wird
selectedGebiet <- reactive({
  input$selectGebiet
})

gebiettxt <- reactive({
  for (i in 1:length(gebiet)){
    if (selectedGebiet() == gebiet[i]) gebiettxt = paste0(gebiet[i],", ",gebietwk[i])
  }
  gebiettxt
})


gebietWK <- reactive({
  for (i in 1:length(gebiet)){
    if (selectedGebiet() == gebiet[i]) gebietWK = gebietwk[i]
  }
  gebietWK
})


renderValueBox({
  valueBox(gebiettxt(), icon = "fa-vote-yea", color = "cornflowerblue")
})
```



Row
-----------------------------------------------------------------------


### Art der Auswertung {.value-box}

```{r}
selectedDarstellung <- reactive({
  input$selectDarstellung
})
renderValueBox({
  valueBox(selectedDarstellung(), icon = "fa-award", color = "gold") 
})
```


### Ausgewertete (Wahl-)Stimme {.value-box}

```{r}
selectedStimme <- reactive({
  input$selectStimme
})
renderValueBox({
  valueBox(selectedStimme(), icon = "fa-car-battery", color = "gold") # Farbe für Stimmenartß
})
```


### Betrachtete Partei {.value-box}

```{r}
selectedPartei <- reactive({
  input$selectPartei
})


partycol <- reactive({
  for (i in 1:length(party)){
    if (selectedPartei() == party[i]) partycol = partycols[i]
  }
  if (selectedDarstellung() != "Parteihochburg") partycol = "white"
  partycol
})
#reactive({
#
  renderValueBox({
    #if (selectedDarstellung() == "Parteihochburg") {
      valueBox(selectedPartei(), icon = "", color = partycol()) # Box in Parteifarbe
    #}
  })
#}
#})
```



Row 
-----------------------------------------------------------------------


### Unverzerrte Karte

```{r}
#datasetgebiet <- reactive({
#  datasetgebiet = selectedGebiet()
#  if (selectedGebiet() == "Neue Länder (+Berlin)") {
#    datasetgebiet = "NeueLaender"
#  }
#  datasetgebiet

#})

#data <- reactive({
#  load(file = paste0("Daten/BTW21",datasetgebiet(),".RData")) # BTW21Parteien,BTW21Rang,BTW21wk_shapes
#  
#})
```

```{r}
renderLeaflet({
  p2 <- mkr.btw21karten(
  maptype = "normalmap",
  Gebiet = selectedGebiet(),
  GebietWK = gebietWK(),
  Darstellung = selectedDarstellung(),
  vote =selectedStimme(),
  party = selectedPartei(),
  partycol = partycol(),
  Shapedf = BTW21wk_shapes, 
  Rangdf  = BTW21Rang,
  Parteidf = BTW21Parteien
  )
  p2 #%>% ggplotly() %>% layout(legend = list(orientation = 'h'))

})



```


### Cartogramm

```{r}
renderLeaflet({
  p1 <- mkr.btw21karten(
  maptype = "cartogram",
  Gebiet = selectedGebiet(),
  GebietWK = gebietWK(),
  Darstellung = selectedDarstellung(),
  vote =selectedStimme(),
  party = selectedPartei(),
  partycol = partycol(),
  Shapedf = BTW21wk_shapes,
  Rangdf  = BTW21Rang,
  Parteidf = BTW21Parteien
  )
  p1 #%>% ggplotly() %>% layout(legend = list(orientation = 'h'))

})

```

